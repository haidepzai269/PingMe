<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Đăng nhập / Đăng ký</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="auth.css" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</head>
<body>
  <div class="auth-wrapper" id="auth-wrapper">
    <div class="auth-image"></div>

    <div class="auth-container">
      <div class="form-box">
        <h2 id="form-title">Đăng nhập - PingMe</h2>
      
        <!-- Form đăng nhập bằng tài khoản -->
        <div id="account-form">
          <input type="text" id="username" placeholder="Tên tài khoản" />
          <input type="password" id="password" placeholder="Mật khẩu" />
          <button id="auth-btn">Đăng nhập</button>
        </div>
      
        <!-- Form đăng nhập bằng điện thoại (ẩn mặc định) -->
        <div id="phone-form" style="display: none;">
          <input type="text" id="phone-number" placeholder="+84xxxxxxxxx" />
          <div id="recaptcha-container"></div>
          <button id="send-otp-btn">Gửi mã OTP</button>
      
          <input type="text" id="otp-code" placeholder="Nhập mã OTP" />
          <button id="verify-otp-btn">Xác nhận OTP</button>
        </div>
      
        <div class="social-login">
          <button onclick="window.location.href='/api/auth/google'" 
                  class="social-btn google" 
                  data-bs-toggle="tooltip" 
                  title="Đăng nhập bằng Gmail">
            <i class="fab fa-google"></i>
          </button>
        
          <button id="facebook-btn" 
                  class="social-btn facebook" 
                  data-bs-toggle="tooltip" 
                  title="Đăng nhập bằng Facebook">
            <i class="fab fa-facebook"></i>
          </button>
        
          <button id="phone-login-btn" 
                  class="social-btn phone" 
                  data-bs-toggle="tooltip" 
                  title="Đăng nhập bằng điện thoại">
            <i class="fa-solid fa-mobile-screen"></i>
          </button>
        </div>
        
        
      
        <p id="toggle-auth">Chưa có tài khoản? <a href="#" id="toggle-link">Đăng ký</a></p>
        <p id="forgot-password"><a href="forgot.html">Bạn quên mật khẩu ✓</a></p>
        <p id="auth-message"></p>
      </div>
      
    </div>
  </div>

  
  <script  src="auth.js"></script>
  <script>
    // Thêm hiệu ứng đổi bên khi toggle đăng ký/đăng nhập
    const wrapper = document.getElementById('auth-wrapper');
    document.getElementById('toggle-auth').addEventListener('click', () => {
      wrapper.classList.toggle('slide-active');
    });
  </script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getAuth, 
      FacebookAuthProvider, 
      signInWithPopup, 
      RecaptchaVerifier, 
      signInWithPhoneNumber 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  
    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAlwyZp9Svz8sArQwbFOHKp5QY5eTHu8Mg",
      authDomain: "pingme-269.firebaseapp.com",
      projectId: "pingme-269",
      storageBucket: "pingme-269.firebasestorage.app",
      messagingSenderId: "545663224529",
      appId: "1:545663224529:web:49bbff0ca2bfdbcd7ed3f0",
      measurementId: "G-7PT6742ME5"
    }; 
  
    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
  
    // ---------------- Facebook login ----------------
    const fbProvider = new FacebookAuthProvider();
    document.getElementById("facebook-btn").addEventListener("click", async () => {
      try {
        const result = await signInWithPopup(auth, fbProvider);
        const user = result.user;
        const idToken = await user.getIdToken();
  
        const res = await fetch("/api/auth/firebase", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ idToken })
        });
  
        const data = await res.json();
        localStorage.setItem("accessToken", data.accessToken);
        localStorage.setItem("refreshToken", data.refreshToken);
        window.location.href = "home.html";
      } catch (err) {
        console.error("Facebook login error:", err);
      }
    });
  
    // ---------------- Phone OTP login ----------------
    window.recaptchaVerifier = new RecaptchaVerifier(
  auth, 
  'recaptcha-container',
  {
    size: 'normal',
    callback: (response) => {
      console.log("reCAPTCHA verified", response);
    }
  }
);


  
    let confirmationResult;
  
    document.getElementById("send-otp-btn").addEventListener("click", async () => {
      const phoneNumber = document.getElementById("phone-number").value;
      try {
        confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier);
        alert("OTP đã gửi!");
      } catch (err) {
        console.error("Send OTP error:", err);
      }
    });
  
    document.getElementById("verify-otp-btn").addEventListener("click", async () => {
      const code = document.getElementById("otp-code").value;
      try {
        const result = await confirmationResult.confirm(code);
        const user = result.user;
        const idToken = await user.getIdToken();
  
        const res = await fetch("/api/auth/firebase", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ idToken })
        });
  
        const data = await res.json();
        localStorage.setItem("accessToken", data.accessToken);
        localStorage.setItem("refreshToken", data.refreshToken);
        window.location.href = "home.html";
      } catch (err) {
        console.error("Verify OTP error:", err);
      }
    });
    
  </script>
   
   <script>
    // Khởi tạo tất cả tooltip của Bootstrap
    document.addEventListener("DOMContentLoaded", function () {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el))
    });
  </script>
  
 
  
</body>
</html>
